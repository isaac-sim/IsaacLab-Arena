name: Isaac Arena CI

on:
  pull_request:
  push:
    branches: [ "main" ]

# Concurrency control to prevent parallel runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: read

env:
  NGC_API_KEY: ${{ secrets.ARENA_NGC_API_KEY }}

jobs:
  test:
    name: Run pre commit checks and tests
    runs-on: [self-hosted, zurich]

    container:
      image: nvcr.io/nvstaging/isaac-amr/isaac_arena:latest
      credentials:
        username: $oauthtoken
        password: ${{ env.NGC_API_KEY }}

    steps:
      - name: Install git (and tools needed by hooks)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends git clang-format ca-certificates
          git --version

      # Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Fix "detected dubious ownership in repository" inside containers
      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$PWD"

      - name: Setup Python
        uses: actions/setup-python@v3

      - name: Run pre-commit
        run: |
          pip install --no-cache-dir --upgrade pip pre-commit
          pre-commit run --all-files

      - name: Run pytest
        run: /isaac-sim/python.sh -m pytest -sv isaac_arena/tests
